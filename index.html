<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>角度インベーダーゲーム</title>
  <style>
    body { background: #000; color: white; font-family: sans-serif; text-align: center; }
    canvas { background: #111; display: block; margin: 10px auto; }
    #controls { margin: 10px; }
    input[type="number"] { width: 60px; }
    #angleDisplay { margin-top: 5px; font-size: 18px; color: gold; }
  </style>
</head>
<body>
  <h1>角度インベーダー</h1>
  <div id="controls">
    <label>角度 (0〜360): <input type="number" id="angleInput" min="0" max="360" value="0"></label>
    <button onclick="prepareFire()">発射！</button>
    <div>スコア: <span id="score">0</span></div>
    <div id="angleDisplay"></div>
  </div>
  <canvas id="gameCanvas" width="600" height="600"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const center = { x: canvas.width / 2, y: canvas.height / 2 };
    let bullets = [];
    let enemies = [];
    let score = 0;
    let firingAngle = 0;
    let currentArc = 0;
    let arcTarget = 0;
    let showAngleArc = false;
    let isPreparingFire = false;

    function drawPointer(angle) {
      ctx.save();
      ctx.translate(center.x, center.y);
      ctx.rotate((angle - 90) * Math.PI / 180); // 0°右 → 90°上
      ctx.strokeStyle = "cyan";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(0, -40);
      ctx.stroke();
      ctx.restore();
    }

    function drawAngleArc(angle) {
      if (!showAngleArc) return;
      ctx.beginPath();
      ctx.moveTo(center.x, center.y);
      ctx.fillStyle = "yellow";
      ctx.arc(center.x, center.y, 50, -Math.PI / 2, (angle - 90) * Math.PI / 180, false);
      ctx.closePath();
      ctx.fill();
    }

    function prepareFire() {
      const angle = parseFloat(document.getElementById("angleInput").value);
      firingAngle = angle;
      arcTarget = angle;
      currentArc = 0;
      showAngleArc = true;
      isPreparingFire = true;
      document.getElementById("angleDisplay").textContent = `入力角度：${angle}°`;
    }

    function fire(angle) {
      const rad = (angle - 90) * Math.PI / 180;
      bullets.push({
        x: center.x,
        y: center.y,
        dx: Math.cos(rad) * 5,
        dy: Math.sin(rad) * 5
      });
    }

    function spawnEnemy() {
      const angle = Math.random() * 2 * Math.PI;
      const radius = 300;
      const x = center.x + radius * Math.cos(angle);
      const y = center.y + radius * Math.sin(angle);
      const dx = (center.x - x) / 1000;
      const dy = (center.y - y) / 1000;
      enemies.push({ x, y, dx, dy });
    }

    function drawBacteria(x, y) {
      ctx.save();
      ctx.translate(x, y);
      ctx.fillStyle = "lime";
      ctx.beginPath();
      for (let i = 0; i < 6; i++) {
        const angle = i * Math.PI / 3;
        const r = 14 + 4 * Math.sin(3 * angle);
        const px = r * Math.cos(angle);
        const py = r * Math.sin(angle);
        if (i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      }
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    function update() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (isPreparingFire && currentArc < arcTarget) {
        currentArc += 2;
        if (currentArc >= arcTarget) {
          currentArc = arcTarget;
          setTimeout(() => {
            fire(firingAngle);
            showAngleArc = false;
            isPreparingFire = false;
          }, 1000);
        }
      }

      drawAngleArc(currentArc);
      drawPointer(currentArc);

      bullets = bullets.filter(b => b.x >= 0 && b.x <= canvas.width && b.y >= 0 && b.y <= canvas.height);
      bullets.forEach(b => {
        b.x += b.dx;
        b.y += b.dy;
        ctx.fillStyle = "aqua";
        ctx.beginPath();
        ctx.arc(b.x, b.y, 4, 0, Math.PI * 2);
        ctx.fill();
      });

      enemies.forEach((e, ei) => {
        e.x += e.dx;
        e.y += e.dy;
        drawBacteria(e.x, e.y);

        bullets.forEach((b, bi) => {
          const dist = Math.hypot(b.x - e.x, b.y - e.y);
          if (dist < 14) {
            enemies.splice(ei, 1);
            bullets.splice(bi, 1);
            score++;
            document.getElementById("score").textContent = score;
          }
        });
      });

      requestAnimationFrame(update);
    }

    spawnEnemy();
    setInterval(spawnEnemy, 3000);

    update();
  </script>
</body>
</html>
